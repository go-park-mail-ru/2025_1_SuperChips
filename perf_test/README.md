# Нагрузочное тестирование

## Краткое описание

Наш сервис, flow -- это сервис для поиска и выкладывания различных медиаматериалов. Таким образом, основная сущность или фундамент нашей бизнес-логики: фотографии.
Нагрузочное тестирование заключалось в выкладывании ста тысяч фотографий.<br>
В качестве инструмента мы выбрали фреймворк `vegeta`, код в `perf.go`. (пункты 1, 2, 3, 4 и 5 подготовки)<br>

## Результаты тестирования

Тестирование было запущено с частотой 40 RPS в течение 2560 секунд. 
Результаты тестирования программой vegeta следующие:

Загрузка фотографий: `POST api/v1/flow`
```
Requests      [total, rate, throughput]         102400, 40.00, 24.40
Duration      [total, attack, wait]             42m40s, 42m40s, 518.427ms
Latencies     [min, mean, 50, 90, 95, 99, max]  15.674ms, 2.395s, 732.599ms, 6.998s, 9.831s, 16.584s, 30.002s
Bytes In      [total, mean]                     4358373, 42.56
Bytes Out     [total, mean]                     5961317505, 58215.99
Success       [ratio]                           61.00%
Status Codes  [code:count]                      0:51  201:62467  500:39882  
Error Set:
500 Internal Server Error
```

При этом видно, что около 39% запросов были выполнено с ошибкой 500, где точкой отказа стала база данных из-за невозможности поддерживать такое количество подключений.

Чтение пина/поста `GET api/v1/flows?id=[id]`. 200 RPS в течение 500 секунд (100000 чтений).
```
Requests      [total, rate, throughput]         100000, 200.00, 200.00
Duration      [total, attack, wait]             8m20s, 8m20s, 1.418ms
Latencies     [min, mean, 50, 90, 95, 99, max]  843.245µs, 1.614ms, 1.23ms, 1.824ms, 2.351ms, 3.82ms, 588.615ms
Bytes In      [total, mean]                     26800000, 268.00
Bytes Out     [total, mean]                     0, 0.00
Success       [ratio]                           100.00%
Status Codes  [code:count]                      200:100000  
Error Set:
```
Как мы видим, с чтением ситуация намного лучше, максимальная задержка в чуть больше полусекунды, при этом выдерживается RPS в 5 раз больше, чем при публикации. 

## Выводы и возможные оптимизации

1. Первое и очевидное изменение, которое требуется провести -- увеличение количества максимальных подключений и, наверное, реализация пула.
2. Второе изменение, касательно кода в го, проверить, что везде подключения отчетливо закрываются по ненадобности.
3. Третье изменение: в коде при добавлении пина мы добавляем 4 его цвета по одному в таблицу color, то есть получается 4 запроса. Можно попробовать использовать unnest.
4. Для вставки лучше использовать prepared statement.
5. Для чтения имеет смысл добавить индексы `CREATE INDEX idx_flow_api_get ON flow (id, author_id, media_url, width, height)` 
6. `CREATE INDEX idx_flow_feed ON flow (is_private, created_at DESC, author_id) WHERE is_private = false;` -- для ленты.

В общем, учитывая ограниченные ресурсы виртуальной машины, кажется, что тестирование на чтение прошло более чем успешно, но тестирование на запись прошло хуже.

